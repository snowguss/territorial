<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Territórios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6750A4;
      --surface-color: #FEF7FF;
      --on-surface-color: #1D1B20;
      --surface-container-high: #ECE6F0;
      --outline-color: #79747E;
    }

    body {
      font-family: 'Noto Sans', sans-serif;
      background-color: var(--surface-container-high);
      color: var(--on-surface-color);
      margin: 0;
      padding-top: 64px; /* Espaço para o header fixo */
      display: flex;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .main-wrapper {
      display: flex;
      width: 100%;
      justify-content: center;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--surface-color);
      color: var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1001;
      height: 64px;
      box-sizing: border-box;
    }

    .header-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--primary-color);
      cursor: pointer;
      padding: 8px;
      box-shadow: none;
    }

    .container {
      background-color: var(--surface-color);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      margin: 20px;
      transition: margin-right 0.3s ease-in-out;
    }

    .map-preview-container {
      width: 40%;
      max-width: 500px;
      margin: 20px 20px 20px 0;
      position: sticky;
      top: 84px; /* 64px header + 20px margin */
      height: calc(100vh - 104px);
      display: flex;
      flex-direction: column;
      background-color: var(--surface-color);
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .map-header {
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--outline-color);
    }

    .map-header h3 {
      margin: 0;
      font-size: 16px;
    }

    #map-iframe {
      flex-grow: 1;
      border: none;
    }

    @media (max-width: 1024px) {
      .map-preview-container {
        display: none; /* Esconde o mapa em telas menores por simplicidade */
      }
    }

    .menu {
      position: fixed;
      top: 64px;
      right: 0;
      background-color: var(--surface-color);
      box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
      border-radius: 0 0 0 12px;
      padding: 10px;
      z-index: 1000;
      width: 250px;
    }

    .menu button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: left;
      padding: 10px 15px;
    }

    .hidden { display: none; }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid var(--outline-color);
      border-radius: 8px;
      font-size: 16px;
      background-color: var(--surface-color);
    }

    input[type="text"]:focus {
      outline: 2px solid var(--primary-color);
      border-color: transparent;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .territorio {
      background-color: var(--surface-container-high);
      border: 1px solid transparent;
      padding: 16px;
      margin: 10px 0;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .territorio-botoes {
      display: flex;
      align-items: center;
      flex-shrink: 0; /* Impede que os botões quebrem linha em telas menores */
    }

    .territorio-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--outline-color);
    }

    .territorio-body {
      display: none; /* Começa recolhido */
      padding-top: 16px;
    }

    .last-sent {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }

    .edit-addr-btn, .edit-btn, .whatsapp-btn, .route-btn, .delete-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 24px;
      padding: 0;
      margin-left: 10px;
      line-height: 1;
    }

    /* Estilos da Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
    }
    .modal-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #modal-enderecos-lista li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <button id="home-btn" class="header-btn" onclick="mostrarTela('home')">&#127968;</button>
    <h1>Gestão de Territórios</h1>
    <button id="hamburger-btn" class="header-btn" onclick="toggleHamburgerMenu()">&#9776;</button>
  </header>

  <div id="hamburger-menu" class="menu hidden">
    <button onclick="mostrarTela('criar'); toggleHamburgerMenu();">Criar Território</button>
    <button onclick="mostrarTela('endereco'); toggleHamburgerMenu();">Adicionar Endereço</button>
    <button onclick="exportarTerritorios(); toggleHamburgerMenu();">Exportar</button>
    <button onclick="document.getElementById('import-file').click(); toggleHamburgerMenu();">Importar</button>
    <button onclick="reorganizarTerritorios(); toggleHamburgerMenu();">Reorganizar Tudo</button>
    <input type="file" id="import-file" class="hidden" onchange="importarTerritorios(event)" accept=".json">
  </div>

  <div class="main-wrapper">
    <div class="container">
      <!-- Tela Criar Território -->
      <div id="telaCriar" class="hidden">
        <h2>Criar Território</h2>
        <div class="form-group">
          <label for="bairro">Bairro:</label>
          <input type="text" id="bairro">
        </div>
        <div class="form-group">
          <label for="nomeTerritorio">Nome do Território:</label>
          <input type="text" id="nomeTerritorio">
        </div>
        <button onclick="criarTerritorio()">Salvar Território</button>
      </div>

      <!-- Tela Adicionar Endereço -->
      <div id="telaEndereco" class="hidden">
        <h2>Adicionar Endereço</h2>
        <div class="form-group">
          <label for="territorioManual">Adicionar ao Território (Opcional):</label>
          <select id="territorioManual" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--outline-color);">
            <option value="">Automático</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ruaInput">Rua:</label>
          <input type="text" id="ruaInput" list="ruas-list">
          <datalist id="ruas-list"></datalist>
        </div>
        <div class="form-group">
          <label for="numeroInput">Número:</label>
          <input type="text" id="numeroInput">
        </div>
        <div class="form-group">
          <label for="bairroEndereco">Bairro:</label>
          <input type="text" id="bairroEndereco" list="bairros-list">
          <datalist id="bairros-list"></datalist>
        </div>
        <div class="form-group">
          <label for="cidadeEndereco">Cidade:</label>
          <input type="text" id="cidadeEndereco" list="cidades-list">
          <datalist id="cidades-list"></datalist>
        </div>
        <div class="form-group">
          <label for="estadoEndereco">Estado (UF):</label>
          <input type="text" id="estadoEndereco" list="estados-list">
          <datalist id="estados-list"></datalist>
        </div>
        <div class="form-group">
          <label for="notasEndereco">Notas:</label>
          <input type="text" id="notasEndereco">
        </div>
        <button onclick="adicionarEndereco()">Adicionar</button>
      </div>

      <h2 id="sugestoes-titulo" class="hidden">Sugestão de Envio</h2>
      <div id="sugestoesTerritorios"></div>

      <h2 id="recentes-titulo" class="hidden">Enviados Recentemente</h2>
      <div id="recentesTerritorios"></div>

      <h2>Territórios</h2>
      <div id="listaTerritorios"></div>
    </div>

    <div id="map-preview" class="map-preview-container hidden">
      <div class="map-header">
        <h3 id="map-title">Prévia da Rota</h3>
        <button class="modal-close" style="position: static; float: none;" onclick="fecharPreviaMapa()">&times;</button>
      </div>
      <iframe id="map-iframe" src="" allowfullscreen="" loading="lazy"></iframe>
    </div>
  </div>

  <!-- Modal de Edição de Endereços -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="fecharModal()">&times;</span>
      <h3 id="modal-titulo">Editar Endereços</h3>
      <ul id="modal-enderecos-lista"></ul>
    </div>
  </div>

  <script>
    let territorios = {};
    const API_KEY = "AIzaSyAHQ5Hofq2sbidxTu8CErNAigz0BfQ4qKg";

    // Carregar territórios do LocalStorage ao iniciar
    window.onload = function() {
      carregarTerritorios();
    };

    function salvarTerritorios() {
      localStorage.setItem('territorios', JSON.stringify(territorios));
    }

    function carregarTerritorios() {
      const dados = localStorage.getItem('territorios');
      if (dados) {
        let dadosCarregados = JSON.parse(dados);
        // Migração de dados para o novo formato de endereço
        for (const bairro in dadosCarregados) {
          dadosCarregados[bairro].forEach(t => {
            t.enderecos = t.enderecos.map(e => {
              if (typeof e === 'string') {
                // Formato antigo: "Rua Exemplo, 123"
                const parts = e.split(',');
                return { rua: parts[0] || e, numero: parts[1] || '', bairro: bairro, cidade: '', estado: '', notas: '', lat: 0, lng: 0 };
              }
              if (e && typeof e === 'object' && e.endereco && !e.rua) {
                // Formato intermediário: { endereco: "...", notas: "..." }
                const parts = e.endereco.split(',');
                return { rua: parts[0] || e.endereco, numero: parts[1] || '', bairro: bairro, cidade: '', estado: '', notas: e.notas || '', lat: 0, lng: 0 };
              }
              // Garante que o campo estado exista
              if (e && typeof e === 'object' && !e.hasOwnProperty('estado')) {
                e.estado = '';
              }
              return e; // Já está no formato novo ou é inválido
            });
          });
        }
        territorios = dadosCarregados;
        atualizarLista();
      }
    }

    function getDistance(coords1, coords2) {
      function toRad(x) {
        return x * Math.PI / 180;
      }

      const R = 6371; // Raio da Terra em km
      const dLat = toRad(coords2.lat - coords1.lat);
      const dLon = toRad(coords2.lng - coords1.lng);
      const lat1 = toRad(coords1.lat);
      const lat2 = toRad(coords2.lat);

      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toggleHamburgerMenu() {
      const menu = document.getElementById('hamburger-menu');
      menu.classList.toggle('hidden');
    }

    function mostrarTela(tela) {
      document.getElementById("telaCriar").classList.add("hidden");
      document.getElementById("telaEndereco").classList.add("hidden");
      if (tela === "criar") {
        document.getElementById("telaCriar").classList.remove("hidden");
      } else if (tela === "endereco") {
        document.getElementById("telaEndereco").classList.remove("hidden");
      }
      // Se a tela for 'home' ou qualquer outra, ambas as seções de formulário permanecem ocultas.
    }

    function criarTerritorio() {
      let bairro = document.getElementById("bairro").value.trim();
      let nome = document.getElementById("nomeTerritorio").value.trim();
      if (!bairro || !nome) {
        alert("Preencha todos os campos!");
        return;
      }

      if (!territorios[bairro]) {
        territorios[bairro] = [];
      }
      territorios[bairro].push({ nome, enderecos: [] });
      salvarTerritorios();
      atualizarLista();
      alert("Território criado!");
      document.getElementById("bairro").value = "";
      document.getElementById("nomeTerritorio").value = "";
    }

    async function adicionarEndereco() {
      const territorioManual = document.getElementById("territorioManual").value;
      const rua = document.getElementById("ruaInput").value.trim();
      const numero = document.getElementById("numeroInput").value.trim();
      const bairroEndereco = document.getElementById("bairroEndereco").value.trim();
      const cidadeEndereco = document.getElementById("cidadeEndereco").value.trim();
      const estadoEndereco = document.getElementById("estadoEndereco").value.trim();
      const notas = document.getElementById("notasEndereco").value.trim();

      if (!rua || !numero || !bairroEndereco || !cidadeEndereco || !estadoEndereco) {
        alert("Preencha os campos de rua, número, bairro, cidade e estado!");
        return;
      }

      const fullAddress = `${rua}, ${numero}, ${bairroEndereco}, ${cidadeEndereco}, ${estadoEndereco}, Brasil`;
      const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(fullAddress)}&key=${API_KEY}`);
      const data = await response.json();

      if (data.status !== "OK") {
        alert("Erro ao buscar endereço: " + data.status);
        return;
      }

      const location = data.results[0].geometry.location; // {lat, lng}
      const newAddressData = { rua, numero, bairro: bairroEndereco, cidade: cidadeEndereco, estado: estadoEndereco, notas, lat: location.lat, lng: location.lng };
      
      // Lógica para adição manual
      if (territorioManual) {
        const [bairroKey, terIndex] = territorioManual.split(';');
        const targetTerritory = territorios[bairroKey][terIndex];
        if (targetTerritory.enderecos.length >= 8) {
          alert(`O território "${targetTerritory.nome}" já está cheio. Não é possível adicionar mais endereços.`);
          return;
        }
        targetTerritory.enderecos.push(newAddressData);
        alert(`Endereço adicionado manually ao território ${targetTerritory.nome}.`);
      } else {
        // Lógica de alocação automática
        let bairro = data.results[0].address_components.find(c => c.types.includes("sublocality") || c.types.includes("political"))?.long_name || bairroEndereco;

        let allTerritories = Object.values(territorios).flat();
        let closestTerritory = null;
        let minDistance = Infinity;

        // Encontra o território mais próximo
        for (const t of allTerritories) {
          if (t.enderecos.length > 0) {
            const baseCoords = t.enderecos[0]; // O primeiro endereço é a base
            const distance = getDistance(baseCoords, newAddressData);
            if (distance < minDistance) {
              minDistance = distance;
              closestTerritory = t;
            }
          }
        }

        // Se o território mais próximo estiver a menos de 5km
        if (closestTerritory && minDistance < 5) {
          if (closestTerritory.enderecos.length < 8) {
            // Adiciona se houver espaço
            closestTerritory.enderecos.push(newAddressData);
            alert(`Endereço adicionado ao território ${closestTerritory.nome}.`);
          } else {
            // Reorganiza se estiver cheio
            alert(`Território ${closestTerritory.nome} está cheio. Tentando reorganizar...`);
            
            // Encontra o endereço mais distante da base no território cheio
            let farthestAddress = null;
            let maxDistance = -1;
            let farthestIndex = -1;

            const baseCoords = closestTerritory.enderecos[0];
            closestTerritory.enderecos.forEach((addr, index) => {
              const dist = getDistance(baseCoords, addr);
              if (dist > maxDistance) {
                maxDistance = dist;
                farthestAddress = addr;
                farthestIndex = index;
              }
            });

            // Remove o mais distante e adiciona o novo
            closestTerritory.enderecos.splice(farthestIndex, 1);
            closestTerritory.enderecos.push(newAddressData);
            alert(`Endereço ${farthestAddress.rua} removido de ${closestTerritory.nome} e o novo endereço foi adicionado.`);
            
            // Tenta realocar o endereço removido (lógica simplificada: cria um novo território para ele)
            const bairroDoRemovido = farthestAddress.bairro;
            const newTerritoryName = `${bairroDoRemovido} ${territorios[bairroDoRemovido] ? territorios[bairroDoRemovido].length + 1 : 1}`;
            if (!territorios[bairroDoRemovido]) {
              territorios[bairroDoRemovido] = [];
            }
            territorios[bairroDoRemovido].push({ nome: newTerritoryName, enderecos: [farthestAddress] });
            alert(`Um novo território "${newTerritoryName}" foi criado para o endereço removido.`);
          }
        } else {
          // Cria um novo território se não houver nenhum próximo
          const newTerritoryName = `${bairro} ${territorios[bairro] ? territorios[bairro].length + 1 : 1}`;
          if (!territorios[bairro]) territorios[bairro] = [];
          territorios[bairro].push({ nome: newTerritoryName, enderecos: [newAddressData] });
          alert(`Nenhum território próximo. Novo território "${newTerritoryName}" criado.`);
        }
      }

      salvarTerritorios();
      atualizarLista();
      document.getElementById("ruaInput").value = "";
      document.getElementById("numeroInput").value = "";
      document.getElementById("bairroEndereco").value = "";
      document.getElementById("cidadeEndereco").value = "";
      document.getElementById("estadoEndereco").value = "";
      document.getElementById("notasEndereco").value = "";
    }

    function editarNomeTerritorio(bairro, index) {
      const territorio = territorios[bairro][index];
      const novoNome = prompt("Digite o novo nome para o território:", territorio.nome);
      const novoBairro = prompt("Digite o novo bairro para o território:", bairro);

      let mudouAlgo = false;

      // Atualiza o nome se for diferente
      if (novoNome && novoNome.trim() !== "" && novoNome.trim() !== territorio.nome) {
        territorio.nome = novoNome.trim();
        mudouAlgo = true;
      }

      // Move o território se o bairro for diferente
      if (novoBairro && novoBairro.trim() !== "" && novoBairro.trim() !== bairro) {
        const bairroAntigo = bairro;
        const bairroNovo = novoBairro.trim();
        
        // Remove o território do array do bairro antigo
        const territorioMovido = territorios[bairroAntigo].splice(index, 1)[0];

        // Se o array do bairro antigo ficou vazio, remove a chave do objeto
        if (territorios[bairroAntigo].length === 0) {
          delete territorios[bairroAntigo];
        }

        // Garante que o array do novo bairro exista
        if (!territorios[bairroNovo]) {
          territorios[bairroNovo] = [];
        }

        // Adiciona o território ao novo bairro
        territorios[bairroNovo].push(territorioMovido);
        mudouAlgo = true;
      }

      if (mudouAlgo) {
        salvarTerritorios();
        atualizarLista();
        alert("Território atualizado com sucesso!");
      }
    }

    function excluirTerritorio(bairro, index) {
      if (confirm(`Tem certeza que deseja excluir o território "${territorios[bairro][index].nome}"?`)) {
        territorios[bairro].splice(index, 1);
        if (territorios[bairro].length === 0) {
          delete territorios[bairro];
        }
        salvarTerritorios();
        atualizarLista();
      }
    }

    function abrirModalEdicao(bairro, terIndex) {
      const modal = document.getElementById('modalEdicao');
      const lista = document.getElementById('modal-enderecos-lista');
      const titulo = document.getElementById('modal-titulo');
      const territorio = territorios[bairro][terIndex];

      titulo.textContent = `Editando: ${territorio.nome}`;
      lista.innerHTML = '';

      territorio.enderecos.forEach((end, enderIndex) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${end.rua}, ${end.numero}</span>
          <div>
            <button class="edit-btn" title="Editar Endereço" onclick="editarEndereco('${bairro}', ${terIndex}, ${enderIndex})">&#9998;</button>
            <button class="delete-btn" title="Excluir Endereço" onclick="excluirEndereco('${bairro}', ${terIndex}, ${enderIndex})">&#128465;</button>
          </div>
        `;
        lista.appendChild(li);
      });

      modal.style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('modalEdicao').style.display = 'none';
    }

    async function editarEndereco(bairro, terIndex, enderIndex) {
      const end = territorios[bairro][terIndex].enderecos[enderIndex];
      const novaRua = prompt("Rua:", end.rua);
      const novoNumero = prompt("Número:", end.numero);
      const novoBairro = prompt("Bairro:", end.bairro);
      const novaCidade = prompt("Cidade:", end.cidade);
      const novoEstado = prompt("Estado (UF):", end.estado);
      const novasNotas = prompt("Notas:", end.notas);

      if (novaRua !== null && novoNumero !== null && novoBairro !== null && novaCidade !== null && novoEstado !== null) {
        const addressChanged = novaRua.trim() !== end.rua ||
                               novoNumero.trim() !== end.numero ||
                               novoBairro.trim() !== end.bairro ||
                               novaCidade.trim() !== end.cidade ||
                               novoEstado.trim() !== end.estado;

        end.rua = novaRua.trim();
        end.numero = novoNumero.trim();
        end.bairro = novoBairro.trim();
        end.cidade = novaCidade.trim();
        end.estado = novoEstado.trim();
        end.notas = novasNotas ? novasNotas.trim() : '';

        if (addressChanged) {
          const fullAddress = `${end.rua}, ${end.numero}, ${end.bairro}, ${end.cidade}, ${end.estado}, Brasil`;
          const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(fullAddress)}&key=${API_KEY}`);
          const data = await response.json();
          if (data.status === "OK") {
            const location = data.results[0].geometry.location;
            end.lat = location.lat;
            end.lng = location.lng;
            alert("Endereço e coordenadas atualizados.");
          } else {
            alert("Endereço atualizado, mas não foi possível atualizar as coordenadas.");
          }
        }

        salvarTerritorios();
        atualizarLista();
        abrirModalEdicao(bairro, terIndex); // Reabre a modal para mostrar a alteração
      }
    }

    function excluirEndereco(bairro, terIndex, enderIndex) {
      if (confirm("Tem certeza que deseja excluir este endereço?")) {
        territorios[bairro][terIndex].enderecos.splice(enderIndex, 1);
        salvarTerritorios();
        atualizarLista();
        abrirModalEdicao(bairro, terIndex); // Reabre a modal para mostrar a alteração
      }
    }

    async function gerarUrlRota(enderecos) {
      if (enderecos.length === 0) return "";
      
      const formatAddress = (e) => `${e.rua}, ${e.numero}, ${e.bairro}, ${e.cidade}, ${e.estado || ''}`;

      const baseUrl = "https://www.google.com/maps/dir/?api=1";
      const origin = `&origin=${encodeURIComponent(formatAddress(enderecos[0]))}`;
      const destination = `&destination=${encodeURIComponent(formatAddress(enderecos[enderecos.length - 1]))}`;
      
      let waypoints = '';
      if (enderecos.length > 2) {
        waypoints = '&waypoints=' + enderecos.slice(1, -1).map(e => encodeURIComponent(formatAddress(e))).join('|');
      }
      
      const longUrl = baseUrl + origin + destination + waypoints;

      try {
        // Usando a API is.gd que suporta CORS com JSONP
        const response = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.shorturl) {
            return data.shorturl;
          }
        }
      } catch (error) {
        console.error("Erro ao encurtar URL, usando URL longa.", error);
      }
      
      return longUrl;
    }

    async function gerarRota(enderecos) {
      if (enderecos.length === 0) {
        alert("Não há endereços para gerar uma rota.");
        return;
      }
      const url = await gerarUrlRota(enderecos);
      window.open(url, '_blank');
    }

    async function gerarMensagemWhatsapp(bairro, territorio) {
      const enderecos = territorio.enderecos;
      if (enderecos.length === 0) {
        alert("Não há endereços neste território para gerar a mensagem.");
        return;
      }

      const titulo = `${bairro.toUpperCase()} - ${territorio.nome.toUpperCase()}`;
      const info = "Las direcciones están organizadas em el orden de la ruta mais eficiente possível; sugerimos que las siga em ordem numérico.";
      const listaEnderecos = enderecos.map((e, i) => {
        let textoEndereco = `${i + 1}. ${e.rua}, ${e.numero}`;
        if (e.notas) {
          // Adiciona a nota em uma nova linha, abaixo do endereço
          textoEndereco += `\n   *Nota: ${e.notas}*`;
        }
        return textoEndereco;
      }).join('\n\n'); // Adiciona um espaço extra entre os endereços
      const pecaAnotacoes = "Envie agora suas anotações de esta tarjeta ao condutor";
      const linkRota = await gerarUrlRota(enderecos);

      const mensagem = `${titulo}\n\n${info}\n\n${listaEnderecos}\n\n${pecaAnotacoes}\n\n${linkRota}`;

      navigator.clipboard.writeText(mensagem).then(() => {
        alert("Mensagem copiada para a área de transferência!");
        // Atualiza a data de envio
        territorio.lastSent = new Date().toISOString();
        salvarTerritorios();
        atualizarLista();
      }).catch(err => {
        console.error("Erro ao copiar mensagem: ", err);
        alert("Não foi possível copiar a mensagem.");
      });
    }

    function toggleCard(bodyId, bairro, terIndex) {
      const body = document.getElementById(bodyId);
      if (body) {
        const isOpening = body.style.display !== 'block';
        // Fecha todos os outros cards abertos
        document.querySelectorAll('.territorio-body').forEach(b => b.style.display = 'none');
        
        if (isOpening) {
          body.style.display = 'block';
          const territorio = territorios[bairro][terIndex];
          abrirPreviaMapa(territorio);
        } else {
          // Se já estava aberto e foi clicado de novo, fecha o mapa também
          fecharPreviaMapa();
        }
      }
    }

    function abrirPreviaMapa(territorio) {
      const mapContainer = document.getElementById('map-preview');
      const mapIframe = document.getElementById('map-iframe');
      const mapTitle = document.getElementById('map-title');
      
      if (!territorio || territorio.enderecos.length === 0) {
        fecharPreviaMapa();
        return;
      }

      mapTitle.textContent = `Rota: ${territorio.nome}`;

      const formatAddress = (e) => `${e.rua}, ${e.numero}, ${e.bairro}, ${e.cidade}, ${e.estado || ''}`;

      const baseUrl = `https://www.google.com/maps/embed/v1/directions?key=${API_KEY}`;
      const origin = `&origin=${encodeURIComponent(formatAddress(territorio.enderecos[0]))}`;
      
      let destination = '';
      let waypoints = '';

      if (territorio.enderecos.length > 1) {
        const lastAddress = territorio.enderecos[territorio.enderecos.length - 1];
        destination = `&destination=${encodeURIComponent(formatAddress(lastAddress))}`;
      } else {
        // Se houver apenas um endereço, o destino é o mesmo que a origem
        destination = `&destination=${encodeURIComponent(formatAddress(territorio.enderecos[0]))}`;
      }

      if (territorio.enderecos.length > 2) {
        waypoints = '&waypoints=' + territorio.enderecos.slice(1, -1).map(e => encodeURIComponent(formatAddress(e))).join('|');
      }

      mapIframe.src = baseUrl + origin + destination + waypoints;
      mapContainer.classList.remove('hidden');
    }

    function fecharPreviaMapa() {
      const mapContainer = document.getElementById('map-preview');
      const mapIframe = document.getElementById('map-iframe');
      mapIframe.src = ''; // Limpa o iframe para parar o carregamento
      mapContainer.classList.add('hidden');
    }

    function ordenarEnderecosParaRota(enderecos) {
      if (enderecos.length < 3) {
        return enderecos; // Não precisa ordenar para 0, 1 ou 2 endereços
      }

      let naoVisitados = [...enderecos];
      let rotaOrdenada = [];

      // Começa com o primeiro endereço da lista original como ponto de partida
      let atual = naoVisitados.shift();
      rotaOrdenada.push(atual);

      while (naoVisitados.length > 0) {
        let maisProximo = null;
        let menorDistancia = Infinity;
        let indiceMaisProximo = -1;

        for (let i = 0; i < naoVisitados.length; i++) {
          const distancia = getDistance(atual, naoVisitados[i]);
          if (distancia < menorDistancia) {
            menorDistancia = distancia;
            maisProximo = naoVisitados[i];
            indiceMaisProximo = i;
          }
        }

        if (maisProximo) {
          atual = maisProximo;
          rotaOrdenada.push(atual);
          naoVisitados.splice(indiceMaisProximo, 1);
        } else {
          // Caso improvável, para evitar loop infinito
          break;
        }
      }

      return rotaOrdenada;
    }

    function otimizarRotaTerritorio(bairro, index) {
      const territorio = territorios[bairro][index];
      if (territorio && territorio.enderecos.length > 2) {
        territorio.enderecos = ordenarEnderecosParaRota(territorio.enderecos);
        salvarTerritorios();
        atualizarLista();
        alert(`Rota para o território "${territorio.nome}" foi otimizada!`);
      } else {
        alert("Não há endereços suficientes para otimizar a rota (necessário mais de 2).");
      }
    }

    function reorganizarTerritorios() {
      if (!confirm("Isso irá reorganizar todos os endereços em novos territórios baseados na proximidade. Deseja continuar?")) {
        return;
      }

      let todosEnderecos = Object.values(territorios).flat().flatMap(t => t.enderecos);
      territorios = {}; // Limpa todos os territórios existentes

      while (todosEnderecos.length > 0) {
        const base = todosEnderecos.shift(); // Pega o primeiro como nova base
        const novoTerritorio = {
          nome: `${base.bairro} ${territorios[base.bairro] ? territorios[base.bairro].length + 1 : 1}`,
          enderecos: [base]
        };

        // Encontra até 7 endereços próximos
        let enderecosProximos = [];
        for (const endereco of todosEnderecos) {
          const distancia = getDistance(base, endereco);
          if (distancia < 5) { // Raio de 5km
            enderecosProximos.push({ endereco, distancia });
          }
        }

        // Ordena por distância e pega os mais próximos
        enderecosProximos.sort((a, b) => a.distancia - b.distancia);
        
        const paraAdicionar = enderecosProximos.slice(0, 7);
        paraAdicionar.forEach(item => {
          novoTerritorio.enderecos.push(item.endereco);
          // Remove o endereço da lista principal
          todosEnderecos = todosEnderecos.filter(e => e !== item.endereco);
        });

        // Otimiza a ordem dos endereços dentro do novo território
        novoTerritorio.enderecos = ordenarEnderecosParaRota(novoTerritorio.enderecos);

        if (!territorios[base.bairro]) {
          territorios[base.bairro] = [];
        }
        territorios[base.bairro].push(novoTerritorio);
      }

      salvarTerritorios();
      atualizarLista();
      alert("Territórios reorganizados com sucesso!");
    }

    function exportarTerritorios() {
      const dataStr = JSON.stringify(territorios, null, 2);
      const dataBlob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'territorios-backup.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function importarTerritorios(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          // Validação simples
          if (typeof importedData === 'object' && importedData !== null) {
            if (confirm("Tem certeza que deseja substituir os dados atuais pelos dados importados?")) {
              territorios = importedData;
              salvarTerritorios();
              atualizarLista();
              alert("Dados importados com sucesso!");
            }
          } else {
            throw new Error("Formato de arquivo inválido.");
          }
        } catch (error) {
          alert("Erro ao importar arquivo: " + error.message);
        } finally {
          // Limpa o valor do input para permitir importar o mesmo arquivo novamente
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    function atualizarFormularios() {
      const selectTerritorio = document.getElementById('territorioManual');
      const bairrosList = document.getElementById('bairros-list');
      const cidadesList = document.getElementById('cidades-list');
      const ruasList = document.getElementById('ruas-list');
      const estadosList = document.getElementById('estados-list');

      // Limpa campos
      selectTerritorio.innerHTML = '<option value="">Automático</option>';
      bairrosList.innerHTML = '';
      cidadesList.innerHTML = '';
      ruasList.innerHTML = '';
      estadosList.innerHTML = '';

      const bairrosSet = new Set();
      const cidadesSet = new Set();
      const ruasSet = new Set();
      const estadosSet = new Set();

      for (const bairroKey in territorios) {
        territorios[bairroKey].forEach((t, index) => {
          // Popula select de territórios
          const option = document.createElement('option');
          option.value = `${bairroKey};${index}`;
          option.textContent = t.nome;
          selectTerritorio.appendChild(option);

          // Popula datalists
          bairrosSet.add(bairroKey);
          t.enderecos.forEach(e => {
            ruasSet.add(e.rua);
            cidadesSet.add(e.cidade);
            bairrosSet.add(e.bairro);
            if(e.estado) estadosSet.add(e.estado);
          });
        });
      }

      bairrosSet.forEach(b => bairrosList.insertAdjacentHTML('beforeend', `<option value="${b}"></option>`));
      cidadesSet.forEach(c => cidadesList.insertAdjacentHTML('beforeend', `<option value="${c}"></option>`));
      ruasSet.forEach(r => ruasList.insertAdjacentHTML('beforeend', `<option value="${r}"></option>`));
      estadosSet.forEach(e => estadosList.insertAdjacentHTML('beforeend', `<option value="${e}"></option>`));
    }

    function atualizarLista() {
      const divSugestoes = document.getElementById("sugestoesTerritorios");
      const divRecentes = document.getElementById("recentesTerritorios");
      const divLista = document.getElementById("listaTerritorios");
      const tituloSugestoes = document.getElementById("sugestoes-titulo");
      const tituloRecentes = document.getElementById("recentes-titulo");
      
      divSugestoes.innerHTML = "";
      divRecentes.innerHTML = "";
      divLista.innerHTML = "";

      let todosTerritorios = [];
      for (let bairro in territorios) {
        territorios[bairro].forEach((t, index) => {
          todosTerritorios.push({ ...t, bairro, originalIndex: index });
        });
      }

      const vinteDiasAtras = new Date();
      vinteDiasAtras.setDate(vinteDiasAtras.getDate() - 20);

      const sugestoes = todosTerritorios
        .filter(t => t.lastSent && new Date(t.lastSent) < vinteDiasAtras)
        .sort((a, b) => new Date(a.lastSent) - new Date(b.lastSent)); // Mais antigos primeiro

      const recentes = todosTerritorios
        .filter(t => t.lastSent && new Date(t.lastSent) >= vinteDiasAtras)
        .sort((a, b) => new Date(b.lastSent) - new Date(a.lastSent)); // Mais novos primeiro

      const naoEnviados = todosTerritorios.filter(t => !t.lastSent);

      const sugestoesParaMostrar = sugestoes.slice(0, 3);
      const recentesParaMostrar = recentes.slice(0, 5);

      const idsMostrados = new Set([
        ...sugestoesParaMostrar.map(t => `${t.bairro}-${t.originalIndex}`),
        ...recentesParaMostrar.map(t => `${t.bairro}-${t.originalIndex}`)
      ]);

      const outros = todosTerritorios.filter(t => !idsMostrados.has(`${t.bairro}-${t.originalIndex}`));

      tituloSugestoes.classList.toggle('hidden', sugestoesParaMostrar.length === 0);
      tituloRecentes.classList.toggle('hidden', recentesParaMostrar.length === 0);

      const renderTerritorio = (t) => {
        const cardId = `territorio-body-${t.bairro.replace(/\s/g, '')}-${t.originalIndex}`;
        
        const lastSentDate = t.lastSent ? new Date(t.lastSent).toLocaleString('pt-BR') : null;
        const lastSentHtml = lastSentDate ? `<div class="last-sent">Enviado em: ${lastSentDate}</div>` : '';

        const enderecosHtml = t.enderecos.map((e, i) => {
          const notaHtml = e.notas ? ` <em>(${e.notas})</em>` : '';
          const enderecoTexto = e.rua ? `${e.rua}, ${e.numero}` : e.endereco || 'Endereço inválido';
          return `${i + 1}. ${enderecoTexto}${notaHtml}`;
        }).join('<br>');

        return `
          <div class="territorio">
            <div style="width: 100%;">
              <div class="territorio-header" onclick="toggleCard('${cardId}', '${t.bairro}', ${t.originalIndex})">
                <div>
                  <strong>${t.bairro} - ${t.nome}</strong>
                  ${lastSentHtml}
                </div>
                <div class="territorio-botoes">
                  <button class="edit-addr-btn" title="Editar Endereços" onclick="event.stopPropagation(); abrirModalEdicao('${t.bairro}', ${t.originalIndex})">&#128221;</button>
                  <button class="edit-btn" title="Editar" onclick="event.stopPropagation(); editarNomeTerritorio('${t.bairro}', ${t.originalIndex})">&#9998;</button>
                  <button class="whatsapp-btn" title="Copiar Mensagem" onclick="event.stopPropagation(); gerarMensagemWhatsapp('${t.bairro}', territorios['${t.bairro}'][${t.originalIndex}])">&#128203;</button>
                  <button class="route-btn" title="Otimizar Rota" onclick="event.stopPropagation(); otimizarRotaTerritorio('${t.bairro}', ${t.originalIndex})">&#x1F504;</button>
                  <button class="route-btn" title="Gerar Rota" onclick="event.stopPropagation(); gerarRota(territorios['${t.bairro}'][${t.originalIndex}].enderecos)">&#128736;</button>
                  <button class="delete-btn" title="Excluir" onclick="event.stopPropagation(); excluirTerritorio('${t.bairro}', ${t.originalIndex})">&#128465;</button>
                </div>
              </div>
              <div class="territorio-body" id="${cardId}">
                <strong>Endereços:</strong><br>
                ${enderecosHtml || 'Nenhum endereço adicionado.'}
              </div>
            </div>
          </div>
        `;
      };

      sugestoesParaMostrar.forEach(t => divSugestoes.insertAdjacentHTML('beforeend', renderTerritorio(t)));
      recentesParaMostrar.forEach(t => divRecentes.insertAdjacentHTML('beforeend', renderTerritorio(t)));
      outros.forEach(t => divLista.insertAdjacentHTML('beforeend', renderTerritorio(t)));

      atualizarFormularios();
    }
  </script>
</body>
</html>
