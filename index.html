<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Territorial - Gestão de Territórios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6750A4;
      --surface-color: #FEF7FF;
      --on-surface-color: #1D1B20;
      --surface-container-high: #ECE6F0;
      --outline-color: #79747E;
    }

    body {
      font-family: 'Noto Sans', sans-serif;
      background-color: var(--surface-container-high);
      color: var(--on-surface-color);
      margin: 0;
      padding-top: 64px; /* Espaço para o header fixo */
      display: flex;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .main-wrapper {
      display: flex;
      width: 100%;
      justify-content: center;
    }

    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--surface-color);
        color: var(--primary-color);
        display: grid;
        grid-template-columns: 64px 1fr 64px;
        align-items: center;
        padding: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1001;
        height: 64px;
        box-sizing: border-box;
    }

    .app-header h1 {
        font-size: 1.5rem;
        margin: 0;
        font-weight: 500;
    }

    .header-btn {
        width: 64px;
        height: 64px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--primary-color);
        cursor: pointer;
        padding: 0;
        box-shadow: none;
        transition: background-color 0.2s;
    }

    .header-btn:hover {
        background-color: rgba(103, 80, 164, 0.08);
    }

    .container {
        background-color: var(--surface-color);
        padding: 32px;
        border-radius: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 1200px;
        margin: 24px;
        display: flex;
        gap: 32px;
    }

    .form-container {
      flex: 1;
      min-width: 300px;
    }

    .list-container {
      flex: 1.5;
      min-width: 300px;
    }

    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
    }

    h1, h2 {
      color: var(--primary-color);
    }

    h1 {
      text-align: center;
      margin-top: 0;
    }

    h2 {
        font-size: 1.5rem;
        margin-bottom: 24px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary-color);
    }

    .menu {
        position: fixed;
        top: 64px;
        right: 0;
        background-color: var(--surface-color);
        box-shadow: -2px 2px 8px rgba(0,0,0,0.1);
        border-radius: 0 0 0 16px;
        padding: 12px;
        z-index: 1000;
        width: 280px;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }

    .menu:not(.hidden) {
        transform: translateX(0);
    }

    .menu button {
        display: block;
        width: 100%;
        margin-bottom: 8px;
        text-align: left;
        padding: 12px 16px;
        transition: background-color 0.2s;
        border-radius: 12px;
    }

    .menu button:hover {
        background-color: rgba(103, 80, 164, 0.85);
    }

    .territorio {
        background-color: var(--surface-container-high);
        border: 1px solid transparent;
        padding: 20px;
        margin: 12px 0;
        border-radius: 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .territorio:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .bairro-grupo {
        margin-bottom: 32px;
    }
    
    .bairro-grupo-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }
    
    .bairro-grupo-header:hover {
        background-color: rgba(103, 80, 164, 0.08);
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid var(--outline-color);
      border-radius: 8px;
      font-size: 16px;
      background-color: var(--surface-color);
    }

    input[type="text"]:focus {
      outline: 2px solid var(--primary-color);
      border-color: transparent;
    }

    button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .hidden { display: none; }

    /* Estilos da Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
    }
    .modal-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #modal-enderecos-lista li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }

    .profile-info {
      margin-bottom: 16px;
    }

    .bairros-lista {
        list-style: none;
        padding: 0;
        margin: 8px 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--outline-color);
        border-radius: 8px;
        display: none;
    }

    .bairros-lista.visible {
        display: block;
    }

    .bairros-lista li {
        padding: 8px 16px;
        cursor: pointer;
    }

    .bairros-lista li:hover {
        background-color: var(--surface-container-high);
    }

    .input-with-toggle {
        display: flex;
        gap: 8px;
    }

    .toggle-btn {
        padding: 0 12px;
        min-width: 40px;
    }

    .bairro-grupo {
        margin-bottom: 24px;
    }
    
    .bairro-grupo-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        cursor: pointer;
    }
    
    .bairro-grupo-header h3 {
        margin: 0;
        color: var(--primary-color);
    }
    
    .bairro-grupo-header .toggle-icon {
        margin-right: 8px;
        color: var(--primary-color);
    }
    
    .bairro-grupo-content {
        margin-left: 16px;
    }

    .container.home .form-container {
        display: none;
    }
    
    .container.home .list-container {
        flex: 1;
    }

    .territorio-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        gap: 16px;  /* Add gap between title and buttons */
        border-bottom: 1px solid var(--outline-color);
    }

    .edit-addr-btn, .edit-btn, .whatsapp-btn, .delete-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 20px;  /* Smaller icon size */
        width: 32px;      /* Fixed width */
        height: 32px;     /* Fixed height */
        padding: 0;
        margin: 0;
        line-height: 1;
        border-radius: 50%;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .territorio-botoes {
        display: flex;
        align-items: center;
        gap: 4px;  /* Space between buttons */
        flex-shrink: 0;
        margin-left: auto;  /* Push buttons to the right */
    }

    .territorio-info {
        flex: 1;
        min-width: 0;  /* Allows text to truncate if needed */
    }

    .welcome-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;  /* Change this from 'flex' to 'none' */
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .welcome-modal:not(.hidden) {
        display: flex;  /* Add this new rule */
    }

    .welcome-content {
        background: var(--surface-color);
        padding: 32px;
        border-radius: 24px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    .welcome-content h2 {
        margin-top: 0;
        text-align: center;
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
    }

    .toast {
      background: var(--surface-color);
      color: var(--on-surface-color);
      padding: 12px 24px;
      border-radius: 12px;
      margin-top: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }

    .toast.success { border-left: 4px solid #4CAF50; }
    .toast.error { border-left: 4px solid #F44336; }
    .toast.info { border-left: 4px solid #2196F3; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Loading spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--surface-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Button loading state */
    button.loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }

    button.loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <button id="home-btn" class="header-btn" onclick="mostrarTela('home')">&#127968;</button>
    <h1><strong>Territorial</strong></h1>
    <button id="hamburger-btn" class="header-btn" onclick="toggleHamburgerMenu()">&#9776;</button>
  </header>

  <div id="hamburger-menu" class="menu hidden">
    <button onclick="mostrarTela('criar'); toggleHamburgerMenu();">Criar Território</button>
    <button onclick="mostrarTela('endereco'); toggleHamburgerMenu();">Adicionar Endereço</button>
    <button onclick="mostrarTela('config'); toggleHamburgerMenu();">Configurações</button>
    <button onclick="reorganizarTerritorios(); toggleHamburgerMenu();">Reorganizar Tudo</button>
  </div>

  <div class="main-wrapper">
    <div class="container home">
      <div class="form-container">
        <!-- Tela Criar Território -->
        <div id="telaCriar" class="hidden">
          <h2>Criar Território</h2>
          <div class="form-group">
            <label for="bairro">Bairro:</label>
            <div class="input-with-toggle">
              <input type="text" id="bairro-input">
              <button class="toggle-btn" onclick="toggleBairrosList(event)" data-target="bairros-select-list">▼</button>
            </div>
            <ul id="bairros-select-list" class="bairros-lista"></ul>
          </div>
          <div class="form-group">
            <label for="nomeTerritorio">Nome do Território:</label>
            <input type="text" id="nomeTerritorio">
          </div>
          <button onclick="criarTerritorio()">Salvar Território</button>
        </div>

        <!-- Tela Adicionar Endereço -->
        <div id="telaEndereco" class="hidden">
          <h2>Adicionar Endereço</h2>
          <div class="form-group">
            <label for="territorioManual">Adicionar ao Território (Opcional):</label>
            <select id="territorioManual" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--outline-color);">
              <option value="">Automático</option>
            </select>
          </div>
          <div class="form-group">
            <label for="ruaInput">Rua:</label>
            <input type="text" id="rua-input" list="ruas-autocomplete">
            <datalist id="ruas-autocomplete"></datalist>
          </div>
          <div class="form-group">
            <label for="numeroInput">Número:</label>
            <input type="text" id="numeroInput">
          </div>
          <div class="form-group">
            <label for="bairroEndereco">Bairro:</label>
            <input type="text" id="bairro-endereco" list="bairros-autocomplete">
            <datalist id="bairros-autocomplete"></datalist>
          </div>
          <button onclick="adicionarEndereco()">Adicionar</button>
        </div>

        <!-- Tela Configurações -->
        <div id="telaConfig" class="hidden">
          <h2>Configurações</h2>
          <!-- View mode -->
          <div id="viewProfile" class="hidden">
            <div class="profile-info">
              <p><strong>Nome:</strong> <span id="viewNome"></span></p>
              <p><strong>Congregação:</strong> <span id="viewCongregacao"></span></p>
              <p><strong>Cidade:</strong> <span id="viewCidade"></span></p>
            </div>
            <div class="stats-info" style="margin: 16px 0; padding: 16px; background: var(--surface-container-high); border-radius: 8px;">
              <h4 style="margin-top: 0; color: var(--primary-color);">Estatísticas</h4>
              <p><strong>Total de Territórios:</strong> <span id="totalTerritorios">0</span></p>
              <p><strong>Total de Endereços:</strong> <span id="totalEnderecos">0</span></p>
            </div>
            <button onclick="toggleProfileMode('edit')" style="margin-bottom: 24px;">Editar Perfil</button>
          </div>
          
          <!-- Edit mode -->
          <div id="editProfile">
            <div class="form-group">
              <label for="nomePublicador">Nome do Publicador:</label>
              <input type="text" id="nomePublicador">
            </div>
            <div class="form-group">
              <label for="congregacao">Congregação:</label>
              <input type="text" id="congregacao">
            </div>
            <div class="form-group">
              <label for="cidadePadrao">Cidade:</label>
              <input type="text" id="cidadePadrao">
            </div>
            <button onclick="salvarPerfil()">Salvar Perfil</button>
          </div>
          
          <h3 style="margin-top: 24px;">Gerenciamento de Dados</h3>
          <button onclick="exportarDados()">Exportar Dados</button>
          <button onclick="document.getElementById('import-file').click();">Importar Dados</button>
          <input type="file" id="import-file" class="hidden" onchange="importarDados(event)" accept=".json">
        </div>
      </div>

      <div class="list-container">
        <h2 id="sugestoes-titulo" class="hidden">Sugestão de Envio</h2>
        <div id="sugestoesTerritorios"></div>

        <h2 id="recentes-titulo" class="hidden">Enviados Recentemente</h2>
        <div id="recentesTerritorios"></div>

        <h2 id="territorios-titulo">Territórios</h2>
        <div id="listaTerritorios"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Edição de Endereços -->
  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="fecharModal()">&times;</span>
      <h3 id="modal-titulo">Editar Endereços</h3>
      <ul id="modal-enderecos-lista"></ul>
    </div>
  </div>

  <!-- Modal de Boas-Vindas -->
  <div id="welcomeModal" class="welcome-modal hidden">
    <div class="welcome-content">
        <h2>Bem-vindo ao Territorial!</h2>
        <p>Para começar, precisamos de algumas informações:</p>
        <div class="form-group">
            <label for="initialNome">Seu Nome:</label>
            <input type="text" id="initialNome" required>
        </div>
        <div class="form-group">
            <label for="initialCongregacao">Sua Congregação:</label>
            <input type="text" id="initialCongregacao" required>
        </div>
        <div class="form-group">
            <label for="initialCidade">Sua Cidade:</label>
            <input type="text" id="initialCidade" required>
        </div>
        <button onclick="salvarPerfilInicial()">Começar</button>
    </div>
  </div>

  <!-- Adicionar antes do fechamento do body -->
  <div class="toast-container"></div>
  <div class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script src="config.js"></script>
  
  <script>
    const domUtils = {
      getElement: (id) => document.getElementById(id),
      getToggleButton: (targetId) => document.querySelector(`button[data-target="${targetId}"]`),
      getBairroInput: () => document.getElementById('bairro-input'),
      getBairrosList: () => document.getElementById('bairros-select-list'),
      getBairrosAutocomplete: () => document.getElementById('bairros-autocomplete'),
      getRuasAutocomplete: () => document.getElementById('ruas-autocomplete')
    };

    let dadosApp = {
        perfil: {
            nome: '',
            congregacao: '',
            cidade: ''
        },
        territorios: {}
    };
    let territorios = {};  // Add this line
    let expandedStates = new Set();
    let isFirstTime = false;

    function salvarDados() {
      dadosApp.territorios = territorios;  // Garante que os territórios estão sincronizados
      localStorage.setItem('dadosApp', JSON.stringify(dadosApp));
    }

    function salvarTerritorios() {
      dadosApp.territorios = territorios;
      salvarDados();
    }

    function carregarDados() {
  const dados = localStorage.getItem('dadosApp');
  if (dados) {
    try {
      dadosApp = JSON.parse(dados);
      territorios = dadosApp.territorios || {};  // Garante que territorios seja sincronizado
      
      // Atualiza campos do perfil
      document.getElementById('nomePublicador').value = dadosApp.perfil.nome || '';
      document.getElementById('congregacao').value = dadosApp.perfil.congregacao || '';
      document.getElementById('cidadePadrao').value = dadosApp.perfil.cidade || '';
      
      // Atualiza a visualização do perfil
      document.getElementById('viewNome').textContent = dadosApp.perfil.nome || '(não definido)';
      document.getElementById('viewCongregacao').textContent = dadosApp.perfil.congregacao || '(não definida)';
      document.getElementById('viewCidade').textContent = dadosApp.perfil.cidade || '(não definida)';
      
      if (dadosApp.perfil.nome || dadosApp.perfil.congregacao || dadosApp.perfil.cidade) {
        toggleProfileMode('view');
      } else {
        toggleProfileMode('edit');
      }
      
      atualizarLista();
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    }
  }
}

// Atualizar window.onload para garantir que os dados são carregados corretamente
window.onload = function() {
  const dados = localStorage.getItem('dadosApp');
  if (dados) {
    try {
      dadosApp = JSON.parse(dados);
      dadosApp = migrarDados(dadosApp);
      territorios = dadosApp.territorios || {};
      
      if (!dadosApp.perfil || !dadosApp.perfil.nome || !dadosApp.perfil.congregacao || !dadosApp.perfil.cidade) {
        isFirstTime = true;
        document.getElementById('welcomeModal').classList.remove('hidden');
      } else {
        carregarDados();
      }
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      isFirstTime = true;
      document.getElementById('welcomeModal').classList.remove('hidden');
    }
  } else {
    isFirstTime = true;
    document.getElementById('welcomeModal').classList.remove('hidden');
  }
};

    function salvarPerfil() {
  const nome = document.getElementById('nomePublicador').value.trim();
  const congregacao = document.getElementById('congregacao').value.trim();
  const cidade = document.getElementById('cidadePadrao').value.trim();

  if (!nome || !congregacao || !cidade) {
    feedback.toast('Por favor, preencha todos os campos!', 'error');
    return;
  }

  dadosApp.perfil = { nome, congregacao, cidade };
  salvarDados();
  
  // Atualiza a visualização
  document.getElementById('viewNome').textContent = nome;
  document.getElementById('viewCongregacao').textContent = congregacao;
  document.getElementById('viewCidade').textContent = cidade;
  
  toggleProfileMode('view');
  feedback.toast('Perfil salvo com sucesso!', 'success');
}

function salvarPerfilInicial() {
        const nome = document.getElementById('initialNome').value.trim();
        const congregacao = document.getElementById('initialCongregacao').value.trim();
        const cidade = document.getElementById('initialCidade').value.trim();

        if (!nome || !congregacao || !cidade) {
            feedback.toast('Por favor, preencha todos os campos!', 'error');
            return;
        }

        dadosApp.perfil = { nome, congregacao, cidade };
        dadosApp.territorios = territorios;
        
        salvarDados();  // Salva tudo no localStorage
        
        const welcomeModal = document.getElementById('welcomeModal');
        welcomeModal.style.display = 'none';
        welcomeModal.classList.add('hidden');
        mostrarTela('home');
        carregarDados();  // Carrega os dados salvos
        atualizarLista();
    }

function toggleProfileMode(mode) {
  const viewMode = document.getElementById('viewProfile');
  const editMode = document.getElementById('editProfile');
  
  if (mode === 'edit') {
    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
  } else {
    // Atualizar contadores antes de mostrar
    const totais = calcularTotais();
    document.getElementById('totalTerritorios').textContent = totais.territorios;
    document.getElementById('totalEnderecos').textContent = totais.enderecos;
    
    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
  }
}

function calcularTotais() {
  let totalTerritorios = 0;
  let totalEnderecos = 0;

  for (const bairro in territorios) {
    totalTerritorios += territorios[bairro].length;
    for (const territorio of territorios[bairro]) {
      totalEnderecos += territorio.enderecos.length;
    }
  }

  return { territorios: totalTerritorios, enderecos: totalEnderecos };
}

    function getDistance(coords1, coords2) {
      function toRad(x) {
        return x * Math.PI / 180;
      }

      const R = 6371; // Raio da Terra em km
      const dLat = toRad(coords2.lat - coords1.lat);
      const dLon = toRad(coords2.lng - coords1.lng);
      const lat1 = toRad(coords1.lat);
      const lat2 = toRad(coords2.lat);

      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toggleHamburgerMenu() {
      const menu = document.getElementById('hamburger-menu');
      menu.classList.toggle('hidden');
    }

    function mostrarTela(tela) {
      const container = document.querySelector('.container');
      document.getElementById("telaCriar").classList.add("hidden");
      document.getElementById("telaEndereco").classList.add("hidden");
      document.getElementById("telaConfig").classList.add("hidden");
      
      if (tela === "home") {
        container.classList.add("home");
      } else {
        container.classList.remove("home");
        if (tela === "criar") {
          document.getElementById("telaCriar").classList.remove("hidden");
        } else if (tela === "endereco") {
          document.getElementById("telaEndereco").classList.remove("hidden");
        } else if (tela === "config") {
          document.getElementById("telaConfig").classList.remove("hidden");
        }
      }
    }

    function criarTerritorio() {
      let bairro = domUtils.getBairroInput().value.trim();
      let nome = document.getElementById("nomeTerritorio").value.trim();
      if (!bairro || !nome) {
        feedback.toast("Preencha todos os campos!", 'error');
        return;
      }

      if (!territorios[bairro]) {
        territorios[bairro] = [];
      }
      territorios[bairro].push({ nome, enderecos: [] });
      salvarTerritorios();
      atualizarLista();
      feedback.toast("Território criado!", 'success');
      domUtils.getBairroInput().value = "";
      document.getElementById("nomeTerritorio").value = "";
    }

    // Adicionar utilitários para feedback
    const feedback = {
      toast(message, type = 'info', duration = 6000) {  // Alterado para 6000ms (6 segundos)
        const container = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      loading: {
        show() {
          document.querySelector('.loading-overlay').style.display = 'flex';
        },
        hide() {
          document.querySelector('.loading-overlay').style.display = 'none';
        }
      },

      setButtonLoading(button, isLoading) {
        if (isLoading) {
          button.classList.add('loading');
          button.disabled = true;
        } else {
          button.classList.remove('loading');
          button.disabled = false;
        }
      }
    };

    // Atualizar função de adicionar endereço
    async function adicionarEndereco() {
      const btn = event.target;
      feedback.setButtonLoading(btn, true);

      try {
        const territorioManual = domUtils.getElement('territorioManual').value;
        const rua = domUtils.getElement('rua-input').value.trim();
        const numero = domUtils.getElement('numeroInput').value.trim();
        const bairroEndereco = domUtils.getElement('bairro-endereco').value.trim();
        
        if (!rua || !numero || !bairroEndereco) {
          feedback.toast('Preencha todos os campos obrigatórios', 'error');
          return;
        }

        const fullAddress = `${rua}, ${numero}, ${bairroEndereco}, ${dadosApp.perfil.cidade}`;
        
        feedback.loading.show();
        const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(fullAddress)}&key=${MAPS_API_KEY}`);
        const data = await response.json();

        if (data.status !== "OK") {
          throw new Error(data.status === "ZERO_RESULTS" ? 
            "Endereço não encontrado. Tente adicionar o CEP ou nome completo da rua e bairro" : 
            "Erro ao buscar endereço. Tente novamente em alguns instantes");
        }

        const location = data.results[0].geometry.location; // {lat, lng}
        const newAddressData = {
          rua,
          numero,
          bairro: bairroEndereco,
          cidade: dadosApp.perfil.cidade,
          notas: '',
          lat: location.lat,
          lng: location.lng
        };
        
        // Lógica para adição manual
        if (territorioManual) {
          const [bairroKey, terIndex] = territorioManual.split(';');
          const targetTerritory = territorios[bairroKey][terIndex];
          if (targetTerritory.enderecos.length >= 8) {
            feedback.toast(`O território "${targetTerritory.nome}" já está cheio. Não é possível adicionar mais endereços.`, 'error');
            return;
          }
          targetTerritory.enderecos.push(newAddressData);
          feedback.toast(`Endereço adicionado manualmente ao território ${targetTerritory.nome}.`, 'success');
        } else {
          // Lógica de alocação automática
          let bairro = data.results[0].address_components.find(c => c.types.includes("sublocality") || c.types.includes("political"))?.long_name || bairroEndereco;

          let allTerritories = Object.values(territorios).flat();
          let closestTerritory = null;
          let minDistance = Infinity;

          // Encontra o território mais próximo
          for (const t of allTerritories) {
            if (t.enderecos.length > 0) {
              const baseCoords = t.enderecos[0]; // O primeiro endereço é a base
              const distance = getDistance(baseCoords, newAddressData);
              if (distance < minDistance) {
                minDistance = distance;
                closestTerritory = t;
              }
            }
          }

          // Se o território mais próximo estiver a menos de 8km
          if (closestTerritory && minDistance < 8) {
            if (closestTerritory.enderecos.length < 8) {
              // Adiciona se houver espaço
              closestTerritory.enderecos.push(newAddressData);
              feedback.toast(`Endereço adicionado ao território ${closestTerritory.nome}.`, 'success');
            } else {
              // Reorganiza se estiver cheio
              feedback.toast(`Território ${closestTerritory.nome} está cheio. Tentando reorganizar...`, 'info');
              
              // Encontra o endereço mais distante da base no território cheio
              let farthestAddress = null;
              let maxDistance = -1;
              let farthestIndex = -1;

              const baseCoords = closestTerritory.enderecos[0];
              closestTerritory.enderecos.forEach((addr, index) => {
                const dist = getDistance(baseCoords, addr);
                if (dist > maxDistance) {
                  maxDistance = dist;
                  farthestAddress = addr;
                  farthestIndex = index;
                }
              });

              // Remove o mais distante e adiciona o novo
              closestTerritory.enderecos.splice(farthestIndex, 1);
              closestTerritory.enderecos.push(newAddressData);
              feedback.toast(`Endereço ${farthestAddress.rua} removido de ${closestTerritory.nome} e o novo endereço foi adicionado.`, 'success');
              
              // Tenta realocar o endereço removido (lógica simplificada: cria um novo território para ele)
              const bairroDoRemovido = farthestAddress.bairro;
              const newTerritoryName = `${bairroDoRemovido} ${territorios[bairroDoRemovido] ? territorios[bairroDoRemovido].length + 1 : 1}`;
              if (!territorios[bairroDoRemovido]) {
                territorios[bairroDoRemovido] = [];
              }
              territorios[bairroDoRemovido].push({ nome: newTerritoryName, enderecos: [farthestAddress] });
              feedback.toast(`Um novo território "${newTerritoryName}" foi criado para o endereço removido.`, 'success');
            }
          } else {
            // Cria um novo território se não houver nenhum próximo
            const newTerritoryName = `${bairro} ${territorios[bairro] ? territorios[bairro].length + 1 : 1}`;
            if (!territorios[bairro]) territorios[bairro] = [];
            territorios[bairro].push({ nome: newTerritoryName, enderecos: [newAddressData] });
            feedback.toast(`Nenhum território próximo. Novo território "${newTerritoryName}" criado.`, 'success');
          }
        }

        salvarTerritorios();
        atualizarLista();
        // Limpar campos
        domUtils.getElement('rua-input').value = "";
        domUtils.getElement('numeroInput').value = "";
        domUtils.getElement('bairro-endereco').value = "";
      } catch (error) {
        feedback.toast(error.message, 'error');
        console.error('Erro:', error);
      } finally {
        feedback.loading.hide();
        feedback.setButtonLoading(btn, false);
      }
    }

    function editarNomeTerritorio(bairro, index) {
      const territorio = territorios[bairro][index];
      const novoNome = prompt("Digite o novo nome para o território:", territorio.nome);
      const novoBairro = prompt("Digite o novo bairro para o território:", bairro);

      let mudouAlgo = false;

      // Atualiza o nome se for diferente
      if (novoNome && novoNome.trim() !== "" && novoNome.trim() !== territorio.nome) {
        territorio.nome = novoNome.trim();
        mudouAlgo = true;
      }

      // Move o território se o bairro for diferente
      if (novoBairro && novoBairro.trim() !== "" && novoBairro.trim() !== bairro) {
        const bairroAntigo = bairro;
        const bairroNovo = novoBairro.trim();
        
        // Remove o território do array do bairro antigo
        const territorioMovido = territorios[bairroAntigo].splice(index, 1)[0];

        // Se o array do bairro antigo ficou vazio, remove a chave do objeto
        if (territorios[bairroAntigo].length === 0) {
          delete territorios[bairroAntigo];
        }

        // Garante que o array do novo bairro exista
        if (!territorios[bairroNovo]) {
          territorios[bairroNovo] = [];
        }

        // Adiciona o território ao novo bairro
        territorios[bairroNovo].push(territorioMovido);
        mudouAlgo = true;
      }

      if (mudouAlgo) {
        salvarTerritorios();
        atualizarLista();
        feedback.toast("Território atualizado com sucesso!", 'success');
      }
    }

    function excluirTerritorio(bairro, index) {
      if (confirm(`Tem certeza que deseja excluir o território "${territorios[bairro][index].nome}"?`)) {
        territorios[bairro].splice(index, 1);
        if (territorios[bairro].length === 0) {
          delete territorios[bairro];
        }
        salvarTerritorios();
        atualizarLista();
        feedback.toast('Território excluído com sucesso!', 'success');
      }
    }

    function abrirModalEdicao(bairro, terIndex) {
      const modal = document.getElementById('modalEdicao');
      const lista = document.getElementById('modal-enderecos-lista');
      const titulo = document.getElementById('modal-titulo');
      const territorio = territorios[bairro][terIndex];

      titulo.textContent = `Editando: ${territorio.nome}`;
      lista.innerHTML = '';

      territorio.enderecos.forEach((end, enderIndex) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${end.rua}, ${end.numero}</span>
          <div>
            <button class="edit-btn" title="Editar Endereço" onclick="editarEndereco('${bairro}', ${terIndex}, ${enderIndex})">&#9998;</button>
            <button class="delete-btn" title="Excluir Endereço" onclick="excluirEndereco('${bairro}', ${terIndex}, ${enderIndex})">&#128465;</button>
          </div>
        `;
        lista.appendChild(li);
      });

      modal.style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('modalEdicao').style.display = 'none';
    }

    function editarEndereco(bairro, terIndex, enderIndex) {
      const end = territorios[bairro][terIndex].enderecos[enderIndex];
      const novaRua = prompt("Rua:", end.rua);
      const novoNumero = prompt("Número:", end.numero);
      const novasNotas = prompt("Notas:", end.notas);

      if (novaRua !== null && novoNumero !== null) {
        end.rua = novaRua.trim();
        end.numero = novoNumero.trim();
        end.notas = novasNotas ? novasNotas.trim() : '';
        salvarTerritorios();
        atualizarLista();
        abrirModalEdicao(bairro, terIndex); // Reabre a modal para mostrar a alteração
      }
    }

    function excluirEndereco(bairro, terIndex, enderIndex) {
      if (confirm("Tem certeza que deseja excluir este endereço?")) {
        territorios[bairro][terIndex].enderecos.splice(enderIndex, 1);
        salvarTerritorios();
        atualizarLista();
        abrirModalEdicao(bairro, terIndex); // Reabre a modal para mostrar a alteração
        feedback.toast('Endereço excluído com sucesso!', 'success');
      }
    }

    async function gerarMensagemWhatsapp(bairro, territorio) {
    const enderecos = territorio.enderecos;
    if (enderecos.length === 0) {
        feedback.toast("Não há endereços neste território para gerar a mensagem.", 'error');
        return;
    }

    const titulo = `*${bairro.toUpperCase()} - ${territorio.nome.toUpperCase()}*`;
    const info = "Las direcciones están organizadas por proximidad; antes de empezar el trabajo, revise el mapa para optimizar su ruta.";
    const listaEnderecos = enderecos.map((e, i) => {
        let textoEndereco = `${i + 1}. *${e.rua}, ${e.numero}*`;
        if (e.notas) {
            textoEndereco += `\n   (${e.notas})`;
        }
        return textoEndereco;
    }).join('\n\n');
    const pecaAnotacoes = "Envie agora las informaciones de esta tarjeta para el conductor!";

    const mensagem = `${titulo}\n\n${info}\n\n${listaEnderecos}\n\n${pecaAnotacoes}`;

    let copiado = false;

    // Primeiro método: Clipboard API
    try {
        await navigator.clipboard.writeText(mensagem);
        copiado = true;
    } catch (err) {
        console.log("Clipboard API falhou, tentando método alternativo...");
    }

    // Segundo método: execCommand (fallback)
    if (!copiado) {
        const textarea = document.createElement('textarea');
        textarea.value = mensagem;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            copiado = document.execCommand('copy');
        } catch (err) {
            console.log("execCommand falhou também");
        }
        
        document.body.removeChild(textarea);
    }

    // Atualiza o território apenas se a cópia foi bem sucedida
    if (copiado) {
        territorio.lastSent = new Date().toISOString();
        dadosApp.territorios = territorios;
        salvarDados();
        atualizarLista();
        feedback.toast("Mensagem copiada para a área de transferência!", 'success');
    } else {
        feedback.toast("Não foi possível copiar a mensagem. Por favor, tente novamente.", 'error');
    }
    }

    function toggleCard(bodyId) {
      const body = document.getElementById(bodyId);
      const icon = document.getElementById(`icon-${bodyId}`);
      if (body) {
        const isVisible = body.style.display === 'block';
        body.style.display = isVisible ? 'none' : 'block';
        icon.textContent = isVisible ? '▶' : '▼';
        
        // Save state
        if (isVisible) {
            expandedStates.delete(bodyId);
        } else {
            expandedStates.add(bodyId);
        }
      }
    }

    function reorganizarTerritorios() {
      if (!confirm("Isso irá reorganizar todos os endereços em novos territórios baseados na proximidade. Deseja continuar?")) {
        return;
      }

      let todosEnderecos = Object.values(territorios).flat().flatMap(t => t.enderecos);
      territorios = {}; // Limpa todos os territórios existentes

      while (todosEnderecos.length > 0) {
        const base = todosEnderecos.shift(); // Pega o primeiro como nova base
        const novoTerritorio = {
          nome: `${base.bairro} ${territorios[base.bairro] ? territorios[base.bairro].length + 1 : 1}`,
          enderecos: [base]
        };

        // Encontra até 7 endereços próximos
        let enderecosProximos = [];
        for (const endereco of todosEnderecos) {
          const distancia = getDistance(base, endereco);
          if (distancia < 8) // Raio de 8km
            enderecosProximos.push({ endereco, distancia });
        }

        // Ordena por distância e pega os mais próximos
        enderecosProximos.sort((a, b) => a.distancia - b.distancia);
        
        const paraAdicionar = enderecosProximos.slice(0, 7);
        paraAdicionar.forEach(item => {
          novoTerritorio.enderecos.push(item.endereco);
          // Remove o endereço da lista principal
          todosEnderecos = todosEnderecos.filter(e => e !== item.endereco);
        });

        if (!territorios[base.bairro]) {
          territorios[base.bairro] = [];
        }
        territorios[base.bairro].push(novoTerritorio);
      }

      salvarTerritorios();
      atualizarLista();
      feedback.toast("Territórios reorganizados com sucesso!", 'success');
    }

    function exportarDados() {
        const dataStr = JSON.stringify(dadosApp, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'territorios-backup.json';
        link.click();
        URL.revokeObjectURL(url);
    }

    function migrarDados(dados) {
    // Se os dados antigos forem apenas territórios
    if (!dados.perfil && !dados.territorios) {
        return {
            perfil: {
                nome: '',
                congregacao: '',
                cidade: ''
            },
            territorios: dados // dados antigos são apenas os territórios
        };
    }

    // Se já estiver no formato novo, apenas garante que tem todos os campos
    if (!dados.perfil) {
        dados.perfil = {
            nome: '',
            congregacao: '',
            cidade: ''
        };
    }

    if (!dados.territorios) {
        dados.territorios = {};
    }

    return dados;
}

    function importarDados(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData === 'object' && importedData !== null) {
                    if (confirm("Tem certeza que deseja importar estes dados?")) {
                        const currentProfile = dadosApp.perfil;
                        dadosApp = migrarDados(importedData);
                        dadosApp.perfil = currentProfile;
                        territorios = dadosApp.territorios;
                        salvarDados();
                        atualizarLista();
                        feedback.toast("Dados importados com sucesso!", 'success');
                    }
                } else {
                    throw new Error("Formato de arquivo inválido.");
                }
            } catch (error) {
                feedback.toast("Erro ao importar arquivo: " + error.message, 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    function atualizarFormularios() {
      const selectTerritorio = domUtils.getElement('territorioManual');
      const bairrosAutocomplete = domUtils.getBairrosAutocomplete();
      const ruasAutocomplete = domUtils.getRuasAutocomplete();

      // Limpar campos
      selectTerritorio.innerHTML = '<option value="">Automático</option>';
      bairrosAutocomplete.innerHTML = '';
      ruasAutocomplete.innerHTML = '';

      const bairrosSet = new Set();
      const ruasSet = new Set();

      for (const bairroKey in territorios) {
        territorios[bairroKey].forEach((t, index) => {
            const option = document.createElement('option');
            option.value = `${bairroKey};${index}`;
            option.textContent = t.nome;
            selectTerritorio.appendChild(option);

            bairrosSet.add(bairroKey);
            t.enderecos.forEach(e => {
                ruasSet.add(e.rua);
                bairrosSet.add(e.bairro);
            });
        });
    }

    bairrosSet.forEach(b => {
        const option = document.createElement('option');
        option.value = b;
        bairrosAutocomplete.appendChild(option);
    });

    ruasSet.forEach(r => {
        const option = document.createElement('option');
        option.value = r;
        ruasAutocomplete.appendChild(option);
    });
}

    function atualizarLista() {
        const divSugestoes = document.getElementById("sugestoesTerritorios");
        const divRecentes = document.getElementById("recentesTerritorios");
        const divLista = document.getElementById("listaTerritorios");
        const tituloSugestoes = document.getElementById("sugestoes-titulo");
        const tituloRecentes = document.getElementById("recentes-titulo");
        
        divSugestoes.innerHTML = "";
        divRecentes.innerHTML = "";
        divLista.innerHTML = "";

        let todosTerritorios = [];
        for (let bairro in territorios) {
            territorios[bairro].forEach((t, index) => {
                todosTerritorios.push({ ...t, bairro, originalIndex: index });
            });
        }

        const vinteDiasAtras = new Date();
        vinteDiasAtras.setDate(vinteDiasAtras.getDate() - 20);

        // Separar territórios por categoria
        const sugestoes = todosTerritorios
            .filter(t => t.lastSent && new Date(t.lastSent) < vinteDiasAtras)
            .sort((a, b) => new Date(a.lastSent) - new Date(b.lastSent));

        const recentes = todosTerritorios
            .filter(t => t.lastSent && new Date(t.lastSent) >= vinteDiasAtras)
            .sort((a, b) => new Date(b.lastSent) - new Date(a.lastSent));

        const naoEnviados = todosTerritorios.filter(t => !t.lastSent);

        // Funções auxiliares para renderização
        const renderTerritorioCard = (t) => {
            const cardId = `territorio-body-${t.bairro.replace(/\s/g, '')}-${t.originalIndex}`;
            const isExpanded = expandedStates.has(cardId);
            
            const lastSentDate = t.lastSent ? new Date(t.lastSent).toLocaleString('pt-BR') : null;
            const lastSentHtml = lastSentDate ? `<div class="last-sent">Enviado em: ${lastSentDate}</div>` : '';

            const enderecosHtml = t.enderecos.map((e, i) => {
                const notaHtml = e.notas ? ` <em>(${e.notas})</em>` : '';
                const enderecoTexto = e.rua ? `${e.rua}, ${e.numero}` : e.endereco || 'Endereço inválido';
                return `${i + 1}. ${enderecoTexto}${notaHtml}`;
            }).join('<br>');

            return `
                <div class="territorio">
                    <div style="width: 100%;">
                        <div class="territorio-header" onclick="toggleCard('${cardId}')">
                            <div class="territorio-info">
                                <strong>${t.bairro} - ${t.nome}</strong>
                                ${lastSentHtml}
                            </div>
                            <div class="territorio-botoes">
                                <button class="edit-addr-btn" title="Editar Endereços" onclick="event.stopPropagation(); abrirModalEdicao('${t.bairro}', ${t.originalIndex})">&#128221;</button>
                                <button class="edit-btn" title="Editar" onclick="event.stopPropagation(); editarNomeTerritorio('${t.bairro}', ${t.originalIndex})">&#9998;</button>
                                <button class="whatsapp-btn" title="Copiar Mensagem" onclick="event.stopPropagation(); gerarMensagemWhatsapp('${t.bairro}', territorios['${t.bairro}'][${t.originalIndex}])">&#128203;</button>
                                <button class="delete-btn" title="Excluir" onclick="event.stopPropagation(); excluirTerritorio('${t.bairro}', ${t.originalIndex})">&#128465;</button>
                            </div>
                        </div>
                        <div class="territorio-body" id="${cardId}" style="display: ${isExpanded ? 'block' : 'none'}">
                            <strong>Endereços:</strong><br>
                            ${enderecosHtml || 'Nenhum endereço adicionado.'}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderBairroGrupo = (territorios, bairro, section) => {
            const grupoId = `grupo-${section}-${bairro.replace(/\s/g, '')}`;
            const isExpanded = expandedStates.has(grupoId);
            return `
                <div class="bairro-grupo">
                    <div class="bairro-grupo-header" onclick="toggleCard('${grupoId}')">
                        <span class="toggle-icon" id="icon-${grupoId}">${isExpanded ? '▼' : '▶'}</span>
                        <h3>${bairro} (${territorios.length})</h3>
                    </div>
                    <div class="bairro-grupo-content" id="${grupoId}" style="display: ${isExpanded ? 'block' : 'none'}">
                        ${territorios.map(t => renderTerritorioCard(t)).join('')}
                    </div>
                </div>
            `;
        };

        // Renderizar sugestões agrupadas por bairro
        if (sugestoes.length > 0) {
            tituloSugestoes.classList.remove('hidden');
            const sugestoesPorBairro = groupByBairro(sugestoes);
            for (const [bairro, territorios] of Object.entries(sugestoesPorBairro)) {
                divSugestoes.insertAdjacentHTML('beforeend', renderBairroGrupo(territorios, bairro, 'sugestoes'));
            }
        } else {
            tituloSugestoes.classList.add('hidden');
        }

        // Renderizar recentes agrupados por bairro
        if (recentes.length > 0) {
            tituloRecentes.classList.remove('hidden');
            const recentesPorBairro = groupByBairro(recentes);
            for (const [bairro, territorios] of Object.entries(recentesPorBairro)) {
                divRecentes.insertAdjacentHTML('beforeend', renderBairroGrupo(territorios, bairro, 'recentes'));
            }
        } else {
            tituloRecentes.classList.add('hidden');
        }

        // Renderizar outros territórios agrupados por bairro
        const outrosPorBairro = groupByBairro(naoEnviados);
        for (const [bairro, territorios] of Object.entries(outrosPorBairro)) {
            divLista.insertAdjacentHTML('beforeend', renderBairroGrupo(territorios, bairro, 'outros'));
        }

        atualizarFormularios();
    }

    // Função auxiliar para agrupar territórios por bairro
    function groupByBairro(territorios) {
        return territorios.reduce((groups, t) => {
            if (!groups[t.bairro]) {
                groups[t.bairro] = [];
            }
            groups[t.bairro].push(t);
            return groups;
        }, {});
    }

    function toggleBairrosList(event) {
    event.preventDefault();
    const targetId = event.target.dataset.target;
    const lista = domUtils.getElement(targetId);
    const button = event.target;
    const isVisible = lista.classList.toggle('visible');
    button.textContent = isVisible ? '▲' : '▼';

    if (isVisible) {
        lista.innerHTML = '';
        const bairros = Object.keys(territorios).sort();
        bairros.forEach(bairro => {
            const li = document.createElement('li');
            li.textContent = bairro;
            li.onclick = () => {
                domUtils.getBairroInput().value = bairro;
                lista.classList.remove('visible');
                button.textContent = '▼';
            };
            lista.appendChild(li);
        });

        if (bairros.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'Nenhum bairro cadastrado';
            li.style.fontStyle = 'italic';
            li.style.color = 'var(--outline-color)';
            lista.appendChild(li);
        }
    }
}

// Atualizar manipulador de clique fora da lista
document.addEventListener('click', function(event) {
    const lista = domUtils.getBairrosList();
    const button = event.target;
    const isToggleButton = button.hasAttribute('data-target');
    
    if (!lista.contains(event.target) && !isToggleButton) {
        lista.classList.remove('visible');
        const toggleBtn = domUtils.getToggleButton('bairros-select-list');
        if (toggleBtn) toggleBtn.textContent = '▼';
    }
});
  </script>
</body>
</html>
